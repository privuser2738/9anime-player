// 9Anime Playlist Player - Custom GUI with full control
console.log('[9Anime Playlist] Loading...');

class PlaylistPlayer {
  constructor() {
    this.episodes = [];
    this.currentIndex = 0;
    this.currentEpisodeId = null;
    this.player = null;
    this.playlist = null;
    this.autoplay = true;
    this.loop = true;

    this.init();
  }

  init() {
    console.log('[9Anime Playlist] Initializing...');

    // Get current episode from URL
    const urlParams = new URLSearchParams(window.location.search);
    this.currentEpisodeId = urlParams.get('ep');

    // Extract all episode links
    this.extractEpisodes();

    // Create player GUI
    setTimeout(() => this.createPlayerGUI(), 2000);
  }

  extractEpisodes() {
    console.log('[9Anime Playlist] Extracting episodes...');

    // Find all links with episode IDs
    const episodeLinks = Array.from(document.querySelectorAll('a[href*="?ep="]'));

    const episodeMap = new Map();

    episodeLinks.forEach(link => {
      const href = link.href;
      const epMatch = href.match(/\?ep=(\d+)/);

      if (epMatch) {
        const epId = epMatch[1];
        const epNumber = this.extractEpisodeNumber(link);

        if (!episodeMap.has(epId)) {
          episodeMap.set(epId, {
            id: epId,
            number: epNumber,
            url: href,
            title: link.textContent.trim() || `Episode ${epNumber}`
          });
        }
      }
    });

    // Convert to array and sort numerically
    this.episodes = Array.from(episodeMap.values())
      .sort((a, b) => parseInt(a.id) - parseInt(b.id));

    // Find current episode index
    this.currentIndex = this.episodes.findIndex(ep => ep.id === this.currentEpisodeId);
    if (this.currentIndex === -1) this.currentIndex = 0;

    console.log('[9Anime Playlist] Found', this.episodes.length, 'episodes');
    console.log('[9Anime Playlist] Current episode:', this.currentIndex + 1);
    console.log('[9Anime Playlist] Episodes:', this.episodes);

    // Filter to show only current and future episodes
    const currentEpId = parseInt(this.currentEpisodeId || this.episodes[0]?.id);
    this.episodes = this.episodes.filter(ep => parseInt(ep.id) >= currentEpId);

    console.log('[9Anime Playlist] Filtered to', this.episodes.length, 'episodes (current onwards)');
  }

  extractEpisodeNumber(element) {
    const text = element.textContent;
    const numberMatch = text.match(/(\d+)/);
    return numberMatch ? parseInt(numberMatch[1]) : 0;
  }

  createPlayerGUI() {
    console.log('[9Anime Playlist] Creating player GUI...');

    // Create overlay container
    const overlay = document.createElement('div');
    overlay.id = 'playlist-player-overlay';
    overlay.innerHTML = `
      <div class="playlist-container">
        <div class="playlist-header">
          <h2>üé¨ Anime Playlist</h2>
          <div class="playlist-info">
            <span id="current-episode">Episode 1</span> / <span id="total-episodes">${this.episodes.length}</span>
          </div>
          <button id="close-playlist" class="btn-close">‚úï</button>
        </div>

        <div class="playlist-content">
          <div class="playlist-list" id="episode-list">
            <!-- Episodes will be added here -->
          </div>
        </div>

        <div class="playlist-controls">
          <button id="btn-prev" class="btn-control">‚èÆ Previous</button>
          <button id="btn-play" class="btn-control btn-play">‚ñ∂ Play</button>
          <button id="btn-next" class="btn-control">Next ‚è≠</button>
          <button id="btn-fullscreen" class="btn-control">‚õ∂ Fullscreen</button>
          <label class="control-option">
            <input type="checkbox" id="toggle-autoplay" checked>
            <span>Autoplay</span>
          </label>
          <label class="control-option">
            <input type="checkbox" id="toggle-loop" checked>
            <span>Loop</span>
          </label>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    // Add styles
    this.addStyles();

    // Populate episode list
    this.populateEpisodeList();

    // Setup controls
    this.setupControls();

    // Auto-start first episode
    setTimeout(() => this.playEpisode(0), 1000);
  }

  populateEpisodeList() {
    const listContainer = document.getElementById('episode-list');

    this.episodes.forEach((episode, index) => {
      const item = document.createElement('div');
      item.className = 'episode-item';
      if (index === this.currentIndex) item.classList.add('active');

      item.innerHTML = `
        <div class="episode-number">${index + 1}</div>
        <div class="episode-title">${episode.title}</div>
        <div class="episode-status">${index === this.currentIndex ? '‚ñ∂ Playing' : ''}</div>
      `;

      item.addEventListener('click', () => this.playEpisode(index));

      listContainer.appendChild(item);
    });
  }

  setupControls() {
    // Close button
    document.getElementById('close-playlist').addEventListener('click', () => {
      document.getElementById('playlist-player-overlay').style.display = 'none';
    });

    // Previous button
    document.getElementById('btn-prev').addEventListener('click', () => {
      this.playPrevious();
    });

    // Play/Pause button
    document.getElementById('btn-play').addEventListener('click', () => {
      this.togglePlayPause();
    });

    // Next button
    document.getElementById('btn-next').addEventListener('click', () => {
      this.playNext();
    });

    // Fullscreen button
    document.getElementById('btn-fullscreen').addEventListener('click', () => {
      this.toggleFullscreen();
    });

    // Autoplay toggle
    document.getElementById('toggle-autoplay').addEventListener('change', (e) => {
      this.autoplay = e.target.checked;
      console.log('[9Anime Playlist] Autoplay:', this.autoplay);
    });

    // Loop toggle
    document.getElementById('toggle-loop').addEventListener('change', (e) => {
      this.loop = e.target.checked;
      console.log('[9Anime Playlist] Loop:', this.loop);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') this.playNext();
      if (e.key === 'ArrowLeft') this.playPrevious();
      if (e.key === ' ') {
        e.preventDefault();
        this.togglePlayPause();
      }
      if (e.key === 'f' || e.key === 'F') this.toggleFullscreen();
    });
  }

  playEpisode(index) {
    if (index < 0 || index >= this.episodes.length) {
      if (this.loop && index >= this.episodes.length) {
        console.log('[9Anime Playlist] End reached, looping back to start');
        index = 0;
      } else {
        console.log('[9Anime Playlist] No more episodes');
        return;
      }
    }

    this.currentIndex = index;
    const episode = this.episodes[index];

    console.log('[9Anime Playlist] Playing episode', index + 1, ':', episode.title);

    // Update UI
    document.getElementById('current-episode').textContent = `Episode ${index + 1}`;

    // Highlight active episode
    document.querySelectorAll('.episode-item').forEach((item, i) => {
      item.classList.toggle('active', i === index);
      const status = item.querySelector('.episode-status');
      status.textContent = i === index ? '‚ñ∂ Playing' : '';
    });

    // Navigate to episode
    window.location.href = episode.url;
  }

  playNext() {
    console.log('[9Anime Playlist] Next episode');
    this.playEpisode(this.currentIndex + 1);
  }

  playPrevious() {
    console.log('[9Anime Playlist] Previous episode');
    this.playEpisode(this.currentIndex - 1);
  }

  togglePlayPause() {
    const video = document.querySelector('video') || this.findVideoInIframe();
    if (video) {
      if (video.paused) {
        video.play();
        document.getElementById('btn-play').innerHTML = '‚è∏ Pause';
      } else {
        video.pause();
        document.getElementById('btn-play').innerHTML = '‚ñ∂ Play';
      }
    }
  }

  toggleFullscreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }

  findVideoInIframe() {
    const iframes = document.querySelectorAll('iframe');
    for (const iframe of iframes) {
      try {
        const video = (iframe.contentDocument || iframe.contentWindow.document).querySelector('video');
        if (video) return video;
      } catch (e) {
        // Cross-origin
      }
    }
    return null;
  }

  addStyles() {
    const style = document.createElement('style');
    style.textContent = `
      #playlist-player-overlay {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 400px;
        max-height: 80vh;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 15px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        z-index: 999999;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: white;
        overflow: hidden;
      }

      .playlist-container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .playlist-header {
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .playlist-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .playlist-info {
        font-size: 14px;
        color: #aaa;
      }

      .btn-close {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: 20px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.2s;
      }

      .btn-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .playlist-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .playlist-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .episode-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        gap: 10px;
      }

      .episode-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }

      .episode-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .episode-number {
        font-size: 16px;
        font-weight: 700;
        min-width: 30px;
      }

      .episode-title {
        flex: 1;
        font-size: 14px;
      }

      .episode-status {
        font-size: 12px;
        color: #4ade80;
      }

      .playlist-controls {
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .btn-control {
        padding: 8px 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        flex: 1;
        min-width: 80px;
      }

      .btn-control:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .btn-play {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        font-weight: 600;
      }

      .control-option {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
        padding: 5px 10px;
        cursor: pointer;
        flex: 1;
      }

      .control-option input {
        cursor: pointer;
      }

      /* Scrollbar */
      .playlist-content::-webkit-scrollbar {
        width: 6px;
      }

      .playlist-content::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      .playlist-content::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }

      .playlist-content::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    `;
    document.head.appendChild(style);
  }
}

// Monitor video for auto-advance
function setupAutoAdvance(player) {
  console.log('[9Anime Playlist] Setting up auto-advance...');

  setInterval(() => {
    const video = document.querySelector('video') || player.findVideoInIframe();

    if (video && player.autoplay) {
      const timeRemaining = video.duration - video.currentTime;

      // When video ends, play next
      if (timeRemaining <= 1 && timeRemaining > 0 && !video.paused) {
        console.log('[9Anime Playlist] Video ending, advancing...');
        setTimeout(() => player.playNext(), 2000);
      }
    }
  }, 1000);
}

// Initialize when on watch page
if (window.location.pathname.includes('/watch/')) {
  const player = new PlaylistPlayer();

  // Setup auto-advance monitoring
  setTimeout(() => setupAutoAdvance(player), 5000);
} else {
  console.log('[9Anime Playlist] Not on watch page');
}
